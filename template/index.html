<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Students Data</title>
<!-- Include SheetJS library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
<!-- <script src="https://code.jquery.com/jquery-3.7.1.slim.min.js" integrity="sha256-kmHvs0B+OpCW5GVHUNjv9rOmY0IvSIRcf7zGUDTDQM8=" crossorigin="anonymous"></script> -->
<style>
  body { font-family: Arial, sans-serif; }
  .container { width: 80%; margin: 20px auto; }
  table { width: 100%; border-collapse: collapse; }
  th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
  th:not(:first-child) { background-color: #f2f2f2; }
  select, button { margin: 10px 0; }
  #pagination { text-align: center; margin-top: 20px; }
</style>
</head>
<body>
<div class="container">
  <h1>Students Data</h1>
  <label for="timeFilter">Filter by Time:</label>
  <select id="timeFilter" onchange="filterByTime()">
    <option value="">All Time</option>
    <option value="week">Last 1 Week</option>
    <option value="month">Last 1 Month</option>
    <option value="6months">Last 6 Months</option>
    <option value="year">Last 1 Year</option>
  </select>
  <label for="groupFilter">Filter by Group:</label>
  <select id="groupFilter" onchange="filterByGroup()">
    <option value="">All Groups</option>
    <!-- Group options will be populated here -->
  </select>
  <button onclick="downloadExcel()">Download Excel</button>
  <table id="jsonTable">
    <thead>
      <tr>
        <th>S/N</th>
        <th>User ID</th>
        <th>Full Name</th>
        <th>User Name</th>
        <th>Profile Link</th>
        <th>Groups</th>
        <th>Is Bot</th>
        <th>Phone Number</th>
        <th>Triggered</th>
        <th>Date</th>
      </tr>
    </thead>
    <tbody>
      <!-- Table rows will be added here dynamically -->
    </tbody>
  </table>
  <!-- Pagination Controls -->
  <div id="pagination">
    <button onclick="changePage(-1)">Prev</button>
    <span id="currentPage">1</span> / <span id="totalPages"></span>
    <button onclick="changePage(1)">Next</button>
  </div>
</div>

<script>
// Your JSON data
var jsonData = {{ data }}
    
// ];

// Global variables for pagination
let currentPage = 1;
const rowsPerPage = 10;

// Function to create table rows from JSON data
function createTableRows(data) {
  const startIndex = (currentPage - 1) * rowsPerPage; // Calculate the starting index for the current page
  return data.map((item, index) => {
    const serialNumber = startIndex + index + 1; // Adjust the serial number based on the current page
    const groupNames = Object.values(item.groups)
      .filter(name => name) // Filter out null values
      .join(', ');
    const dateOptions = { year: 'numeric', month: 'long', day: 'numeric' }; // Options to show only date
    return `
      <tr>
        <td>${serialNumber}</td>
        <td>${item.user_id["$numberLong"] || item.user_id}</td>
        <td>${item.full_name}</td>
        <td>${item.user_name || 'N/A'}</td>
        <td>${item.profile_link ? `<a href="${item.profile_link}">Profile</a>` : 'N/A'}</td>
        <td>${groupNames}</td>
        <td>${item.is_bot}</td>
        <td>${item.phone_number || 'N/A'}</td>
        <td>${item.triggered}</td>
        <td>${new Date(item.epoctime * 1000).toLocaleDateString('en-US', dateOptions)}</td>
      </tr>
    `;
  }).join('');
}

// Function to render the table with JSON data
function renderTable(filteredData = jsonData) {
  const startIndex = (currentPage - 1) * rowsPerPage;
  const endIndex = startIndex + rowsPerPage;
  const paginatedData = filteredData.slice(startIndex, endIndex);
  const tableBody = document.getElementById('jsonTable').querySelector('tbody');
  tableBody.innerHTML = createTableRows(paginatedData);
}

// Function to filter data by time
function filterByTime() {
  currentPage = 1; // Reset to the first page
  const selectedTime = document.getElementById('timeFilter').value;
  const now = new Date();
  const filteredData = jsonData.filter(item => {
    const itemDate = new Date(item.epoctime * 1000);
    switch (selectedTime) {
      case 'week':
        return now - itemDate <= 7 * 24 * 60 * 60 * 1000; // Last 1 week
      case 'month':
        return now - itemDate <= 30 * 24 * 60 * 60 * 1000; // Last 1 month
      case '6months':
        return now - itemDate <= 6 * 30 * 24 * 60 * 60 * 1000; // Last 6 months
      case 'year':
        return now - itemDate <= 12 * 30 * 24 * 60 * 60 * 1000; // Last 1 year
      default:
        return true; // All time
    }
  });
  renderTable(filteredData);
  updatePaginationDisplay();
}

// Function to filter data by group
function filterByGroup() {
  currentPage = 1; // Reset to the first page
  const selectedGroup = document.getElementById('groupFilter').value;
  const filteredData = jsonData.filter(item => {
    const groupNames = Object.values(item.groups).filter(name => name);
    return selectedGroup === "" || groupNames.includes(selectedGroup);
  });
  renderTable(filteredData);
  updatePaginationDisplay();
}

// Function to populate group filter options
function populateGroupOptions() {
  const groupSet = new Set();
  jsonData.forEach(item => {
    Object.values(item.groups).forEach(group => {
      if (group) groupSet.add(group);
    });
  });
  const groupFilter = document.getElementById('groupFilter');
  groupSet.forEach(group => {
    groupFilter.add(new Option(group, group));
  });
}

// Function to download the data in Excel format
function downloadExcel() {
  const ws = XLSX.utils.table_to_sheet(document.getElementById('jsonTable'));
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Students Data');
  XLSX.writeFile(wb, 'StudentsData.xlsx');
}

// Function to update the current page
function changePage(step) {
  const totalPages = Math.ceil(jsonData.length / rowsPerPage);
  currentPage += step;
  currentPage = Math.max(1, Math.min(currentPage, totalPages)); // Clamp between 1 and totalPages
  document.getElementById('currentPage').textContent = currentPage;
  renderTable();
}

// Function to initialize pagination
function initPagination() {
  const totalPages = Math.ceil(jsonData.length / rowsPerPage);
  document.getElementById('totalPages').textContent = totalPages;
  document.getElementById('currentPage').textContent = currentPage;
}

// Function to update pagination display
function updatePaginationDisplay() {
  const totalPages = Math.ceil(jsonData.length / rowsPerPage);
  document.getElementById('totalPages').textContent = totalPages;
  document.getElementById('currentPage').textContent = currentPage;
}

// Call the functions on page load
window.onload = () => {
  renderTable();
  populateGroupOptions();
  initPagination();
};
</script>
</body>
</html>
